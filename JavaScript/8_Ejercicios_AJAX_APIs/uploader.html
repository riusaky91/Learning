<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploader con AJAX</title>

<style>
    html {
    box-sizing: border-box; /*resetea el borde*/
    font-family: sans-serif; /*tipo de Fuente*/
    font-size: 16px; /*tamaño de fuente*/
  }

    *,/*todos los elementos*/
    *:before,/*todos los elementos antes*/
    *:after {
    /*todos los elementos antes*/
    box-sizing: inherit; /*Herede el borde del padre tamaño de las cajas empezaran desde el borde*/
  }

  main{
    display: flex;/*Manejo de flex box*/
    flex-direction: column;/*Manejo columnar para el elemento*/
    justify-content: center;/*Centrado en el eje principal*/
    align-items: center;/*Centrado en el eje horizontal*/
    text-align: center;/*Centrado del texto*/
    min-height: 100vh;/*altura minima para la vista en el documento*/
  }

  progress {
    margin-top: 1rem;/*Espaciado de margen arriba*/
  }
</style>
</head>
<body>
    <main>
        <input type="file" id="files" name="files" multiple><!--Input tipo file para subir un archivo-->
    </main>
    <script>
        const d = document,//declar e inicializo la variable d coon la palabra reservada document
        $main = d.querySelector("main"),//declaro e inicializo la varable $main con el elemento de tipo main
        $files = d.getElementById("files");//declaro e inicializo la variable con el elemento que tiene como id files

        const uploader = async (file) =>{//declaro funcion expresada asincrona que recibe la varable file para su ejecucion
            console.log(file);
            const formData = new FormData();//Declaro en inicializo contante con el valor de un objeto tipo FormData

            formData.append("file",file);//al form data le agrego la variable file que contiene el archivo

            try {
                let res = await fetch("assets/uploader.php", //URL del end point
                {
                    method: "POST", //metodo a utilizar de la peticion
                    body: formData //cuerpo de la peticion
                    //headers: { "enc-type","multipart/form-data" }//Cabecera con la naturaleza delos datos a enviar
                }); //declaro e inicializo variable que detendra la ejecucion del codigo hasta que traiga los recursos solicitados en fetch y los alamcene ne la variable
             
                if (!res.ok) {
                    //Si la respuesta no es satisfactoria o esta fallando
                    throw { status: res.status, statusText: res.statusText }; //dentro del try catch para enviar al catch se utiliza el throw
                }

                let json = await res.json(); //declaro e inicializo variable que detendra la ejecucion del codigo hasta que reciba la respuesta html y los alamcene en la variable
                
                console.log(json);
            } catch (error) {
                console.log(error); //Ejecuto el metodo error del objeto enviado
            }


        }


        const progressUpload = (file)=>{//Funcion expresada que reciobe un archivo para cargarlo al servidor 
            const $progress = d.createElement("progress"),//declaro en inicializo constante creando el elemento progress
                $span = d.createElement("span");//declaro en inicializo constante creando el elemento span

            $progress.value = 0;//asigo el valor inicial para el atributo value del elemento progress
            $progress.max = 100;//asigo el valor maximo para el atributo max del elemento progress


            $main.insertAdjacentElement("beforeend", $progress);//agrego el elemento creado al docuemnt despues del main 
            $main.insertAdjacentElement("beforeend", $span);//agrego el elemento creado al docuemnt despues del main

            const fileReader = new FileReader();//Detecta los bits que van cargados para hacer el calculo de porcentaje de cada archivo
            fileReader.readAsDataURL(file);//aenvio el archivo para que sea leido por el metodo del objeto


            fileReader.addEventListener("progress", e=>{//Evento que se ejecuta cada vez que se avance en el progreso de carga del archivo
                let progress = parseInt((e.loaded * 100)/e.total);//declaro e inicializo variable con el porcentaje de carga e.loaded que se tiene sobre el porcentaje total e.total
                $progress.value = progress;//asigno el valor al atributo value del elemento progress 
                $span.innerHTML=`<b>${file.name}- ${progress}%</b>`;//asigno el valor al atributo innerHTML del elemento span
                
            });
            fileReader.addEventListener("loadend", e=>{//Evento que se ejecuta cuando finaliza la carga del archivo
                $progress.value = 100;//asigno el 100 de carga
                $span.innerHTML=`<b>${file.name}- 100%</b>`;//asgino el texto al 100%
                uploader(file);//cargo el archivo que se encontraba en el temporal
                setTimeout(()=>{//asigno un tiempo especifico para limpiar los valores del documento
                    $main.removeChild($progress);
                    $main.removeChild($span);
                    $files.value = "";
                },3000)
            });
        
        }


        d.addEventListener("change", e =>{//Metodo tipo evento qque se ejecuta cuando hay un cambio en el docuemnto
            if(e.target === $files){
                console.log(e.target.files);

                const files = Array.from(e.target.files);//declaro e inicializo constante files que convierte en arreglo iterable
                files.forEach(file=>{//recorro la constante y por cada iteracion de un archivo
                    progressUpload(file);//ejecuto el metodo progressuploader
                });

            }
        })
    </script>
</body>
</html>